<body>
<app-headerocionocturno></app-headerocionocturno>
<div class="middle-content">
  <div class="container py-5 card-ev">
    <div class="card detail  col-12 col-md-12 col-lg-3 my-3 " style="height: 100%">
      <img src="{{evento?.cartel}}" class="card-img-top" alt="...">
      <div class="card-body event">
        <h2 class="card-title"><b>Información</b></h2>
        <p class=" text">{{ evento?.nombre }}</p>
        <p class=" text">{{ evento?.descripcion }}</p>
        <p class=" text">Temática: {{ evento?.tematica }}</p>
        <h2 class="card-title"><b>Ubicación</b></h2>
        <p class=" text">{{ evento?.ocioNocturnoDTO?.nombre }}</p>
        <p class=" text">
          {{ evento?.ocioNocturnoDTO?.direccionDTO?.calle }},
          {{ evento?.ocioNocturnoDTO?.direccionDTO?.codigoPostal }},
          {{ evento?.ocioNocturnoDTO?.direccionDTO?.ciudad }},
          {{ evento?.ocioNocturnoDTO?.direccionDTO?.provincia }},
          {{ evento?.ocioNocturnoDTO?.direccionDTO?.pais }}
        </p>
      </div>
    </div>

    <div class="ev-detail">
      <div class="info-detail">
        <h3><a style="display: flex;align-items: center !important;">
          <ion-icon name="calendar"></ion-icon>
          {{ fechaEvento }} /</a>
          <a class="mini-detail">
            <ion-icon name="watch"></ion-icon>
            {{ evento?.ocioNocturnoDTO?.horaApertura }}
            <ion-icon name="arrow-forward"></ion-icon>
            {{ evento?.ocioNocturnoDTO?.horaCierre }}
          </a></h3>
      </div>
      <div>
        <h1 style="font-size: xx-large">{{ evento?.nombre }}</h1>
      </div>
      <div class="tags">
        <ion-badge color="secondary" slot="start">+{{ edadMinima }}</ion-badge>
        <ion-badge color="secondary" slot="start" class="second">
          <ion-icon name="shirt-outline"></ion-icon>
          {{ codigoVestimenta }}
        </ion-badge>
      </div>

      @if (evento?.fecha! < fechaActual) {
        <div class="entradas-generales">
          <div class="row card-row card-style">
            <div class="card detail  col-12 col-md-12 col-lg-3 my-3 " style="width: 100%;"
                 (click)="setOpenGeneral(true, true, false, false)">
              <div class="card-body event">
                <div class="tarifa">
                  <h1>GENERAL {{ evento?.nombre }}</h1>
                  <div class="info">
                    <button class="button is-large is-light"
                            style="padding: .4rem !important;margin-right: .5rem !important;">
                      {{ informacionTiposEntrada?.entradaOcioDTO?.precio }}€
                    </button>
                    <button class="button is-large is-link">
                      <ion-icon name="arrow-forward"></ion-icon>
                    </button>
                  </div>
                </div>
                <hr>
                <div class="content">
                  <p class=" text">{{ informacionTiposEntrada?.entradaOcioDTO?.detalleEntrada }}</p>
                  <p class=" text">Precio: {{ informacionTiposEntrada?.entradaOcioDTO?.precio }}€</p>
                  <p class=" text">Incluye {{ informacionTiposEntrada?.entradaOcioDTO?.consumiciones }}
                    consumición/es.</p>
                  <p class=" text">Incluye acceso al establecimiento.</p>
                  <p class=" text">Obligatorio mostrar el DNI y el código QR para acceder.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="reservados">
          <div class="row card-row card-style">
            <div class="card detail  col-12 col-md-12 col-lg-3 my-3 "
                 style="width: 100%;"
                 (click)="setOpenGeneral(true, false, true, false)">
              <div class="card-body event">
                <div class="tarifa">
                  <h1>RESERVADO {{ evento?.nombre }}</h1>
                  <div class="info">
                    <button class="button is-large is-light bg-gray-300/30"
                            style="padding: .4rem !important;margin-right: .5rem !important;">
                      {{ informacionTiposEntrada?.reservadoOcioDTO?.precio }}€
                    </button>
                    <button class="button is-large is-link">
                      <ion-icon name="arrow-forward"></ion-icon>
                    </button>
                  </div>
                </div>
                <hr>
                <div class="content">
                  <p class=" text">{{ informacionTiposEntrada?.reservadoOcioDTO?.detalleReservado }}</p>
                  <p class=" text">Precio: {{ informacionTiposEntrada?.reservadoOcioDTO?.precio }}€</p>
                  <p class=" text">Incluye {{ informacionTiposEntrada?.reservadoOcioDTO?.botellas }} botella/s.</p>
                  <p class=" text">Incluye acceso al establecimiento.</p>
                  <p class=" text">Obligatorio mostrar el DNI y el código QR para acceder.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="listas">
          <div class="row card-row card-style">
            <div class="card detail  col-12 col-md-12 col-lg-3 my-3 " style="width: 100%;"
                 (click)="setOpenGeneral(true, false, false, true)">
              <div class="card-body event">
                <div class="tarifa">
                  <h1>LISTA {{ evento?.nombre }}</h1>
                  <div class="info">
                    <button class="button is-large is-light bg-gray-300/30"
                            style="padding: .4rem !important;margin-right: .5rem !important;">
                      {{ informacionTiposEntrada?.listaOcioDTO?.precio }}€
                    </button>
                    <button class="button is-large is-link">
                      <ion-icon name="arrow-forward"></ion-icon>
                    </button>
                  </div>
                </div>
                <hr>
                <div class="content">
                  <p class=" text">LISTA
                    DE {{ informacionTiposEntrada?.listaOcioDTO?.rppDTO?.nombre }} {{ informacionTiposEntrada?.listaOcioDTO?.rppDTO?.apellidos }}</p>
                  <p class=" text">{{ informacionTiposEntrada?.listaOcioDTO?.detalleLista }}</p>
                  <p class=" text">Precio: {{ informacionTiposEntrada?.listaOcioDTO?.precio }}€</p>
                  <p class=" text">Incluye {{ informacionTiposEntrada?.listaOcioDTO?.consumiciones }}
                    consumición/es.</p>
                  <p class=" text">Incluye acceso al establecimiento.</p>
                  <p class=" text">Obligatorio mostrar el DNI y el código QR para acceder.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ion-modal [isOpen]="isModalOpen">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                @if (isGeneral) {
                  <ion-title>GENERAL {{ evento?.nombre }}</ion-title>
                } @else if (isReservado) {
                  <ion-title>RESERVADO {{ evento?.nombre }}</ion-title>
                } @else if (isLista) {
                  <ion-title>
                    LISTA {{ evento?.nombre }},
                    CREADA
                    POR: {{ informacionTiposEntrada?.listaOcioDTO?.rppDTO?.nombre }} {{ informacionTiposEntrada?.listaOcioDTO?.rppDTO?.apellidos }}
                  </ion-title>
                }
                <ion-buttons slot="end">
                  <ion-button (click)="setOpenGeneral(false, false, false, false)" style="padding: 0 !important;">
                    <ion-icon name="close-outline"></ion-icon>
                  </ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="form-content ion-padding ">
              <div class="dispo">

                <mat-stepper orientation="vertical" [linear]="isLinear" #stepper>
                  @if (isGeneral || isLista) {
                    <mat-step [stepControl]="firstFormGroup">
                      <form [formGroup]="firstFormGroup">
                        <ng-template matStepLabel style="width: 100%">
                          <div class="select-cantidad">
                            <mat-form-field>
                              <mat-label>Seleccionar cantidad</mat-label>
                              <mat-select>
                                @for (d of disponibilidad; track d) {
                                  <mat-option [value]="d" (click)="actualizarCantidadGeneral(d)">{{ d }}</mat-option>
                                }
                              </mat-select>
                            </mat-form-field>
                          </div>
                        </ng-template>
                      </form>
                    </mat-step>
                  } @else if (isReservado) {
                    <mat-step [stepControl]="firstFormGroup">
                      <form [formGroup]="firstFormGroup">
                        <ng-template matStepLabel style="width: 100%">
                          <div class="select-cantidad">
                            <mat-form-field>
                              <mat-label>Seleccionar número de personas</mat-label>
                              <mat-select>
                                @for (d of disponibilidadReservado; track d) {
                                  <mat-option [value]="d" (click)="actualizarPersonasReservado(d)">{{ d }}</mat-option>
                                }
                              </mat-select>
                            </mat-form-field>
                          </div>
                        </ng-template>
                      </form>
                    </mat-step>
                  }
                  @if (cantidad != 0) {
                    @for (c of datosARellenar; track c; let first = $first) {
                      <mat-step [stepControl]="datosCompradores">
                        <form [formGroup]="datosCompradores">
                          <ng-template matStepLabel>Datos del asistente {{ c + 1 }}</ng-template>

                          @if (first) {
                            <mat-form-field>
                              <mat-label>Nombre</mat-label>
                              <input matInput formControlName="nombre" required value="{{cliente?.nombre}}">
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Apellidos</mat-label>
                              <input matInput formControlName="apellidos" required value="{{cliente?.apellidos}}">
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Email</mat-label>
                              <input matInput formControlName="email" required type="email">
                            </mat-form-field>


                            <mat-form-field>
                              <mat-label>Fecha Nacimiento</mat-label>
                              <input matInput [matDatepicker]="picker" formControlName="fecha"
                                     value="{{cliente?.fecha_nacimiento}}">
                              <mat-datepicker-toggle matIconSuffix [for]="picker">
                                <mat-icon matDatepickerToggleIcon>keyboard_arrow_down</mat-icon>
                              </mat-datepicker-toggle>
                              <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Genero</mat-label>
                              <mat-select>
                                @for (g of generos; track g) {
                                  <mat-option (click)="addGeneroToForm(g)" value="{{g}}">{{ g }}</mat-option>
                                }
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Teléfono</mat-label>
                              <input matInput formControlName="telefono" value="{{cliente?.telefono}}">
                            </mat-form-field>

                            <div>
                              @if (datoYaEnviado(c)){
                                <button [disabled]="true" mat-button matStepperNext>Añadir</button>
                              }@else{
                                <button mat-button (click)="addForm(c)">Añadir</button>
                              }
                              <button mat-button matStepperNext>Next</button>
                            </div>

                          } @else {

                            <mat-form-field>
                              <mat-label>Nombre</mat-label>
                              <input matInput formControlName="nombre" required>
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Apellidos</mat-label>
                              <input matInput formControlName="apellidos" required>
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Email</mat-label>
                              <input matInput formControlName="email" required type="email">
                            </mat-form-field>


                            <mat-form-field>
                              <mat-label>Fecha Nacimiento</mat-label>
                              <input matInput [matDatepicker]="picker" formControlName="fecha">
                              <mat-datepicker-toggle matIconSuffix [for]="picker">
                                <mat-icon matDatepickerToggleIcon>keyboard_arrow_down</mat-icon>
                              </mat-datepicker-toggle>
                              <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>

                            <mat-form-field>
                              <mat-label>Genero</mat-label>
                              <mat-select>
                                @for (g of generos; track g) {
                                  <mat-option [value]="g">{{ g }}</mat-option>
                                }
                              </mat-select>
                            </mat-form-field>


                            <mat-form-field>
                              <mat-label>Teléfono</mat-label>
                              <input matInput formControlName="telefono">
                            </mat-form-field>

                            <div>
                              <button mat-button matStepperNext (click)="addForm(c)">Añadir</button>
                              <button mat-button matStepperNext>Next</button>
                            </div>
                          }


                        </form>
                      </mat-step>
                    }
                    @if (verPromocion) {
                      <mat-step>
                        <ng-template matStepLabel>Promociones</ng-template>
                        <div class="promocion">
                          <mat-form-field>
                            <mat-label>Seleccionar Promoción</mat-label>
                            <mat-select>
                              @for (p of promocionesActivas; track p) {
                                <mat-option value="{{p.id}}" (click)="promocion(p!)">{{ p.tipoPromocion }}</mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field>
                            <mat-label>Código</mat-label>
                            <input matInput [(ngModel)]="codigoPromocion">
                          </mat-form-field>
                          <button style="margin-bottom: 12px;" mat-button (click)="validarPromocion()">Validar</button>
                        </div>
                        <button mat-button matStepperNext (click)="pagarOpen()">Siguiente</button>

                      </mat-step>
                    }

                    @if (pagar) {
                      <mat-step>
                        <ng-template matStepLabel>Finalizar y pagar</ng-template>
                        <div>
                          <button mat-button (click)="comprar()">Pagar</button>
                        </div>
                      </mat-step>
                    }
                  }
                </mat-stepper>

                <div class="card" style="width: 18rem;height: 100%">
                  <div class="card-body">
                    <h1 class="card-title">RESUMEN COMPRA</h1>
                    <h3 class="resumen card-subtitle mb-2 text-body-secondary">
                      <div>
                        x{{ cantidad }} {{ evento?.nombre }}
                      </div>
                      @if (isGeneral) {
                        <div>
                          {{ informacionTiposEntrada?.entradaOcioDTO?.precio }}€
                        </div>
                      } @else if (isReservado){
                        <div>
                          {{ informacionTiposEntrada?.reservadoOcioDTO?.precio }}€
                        </div>
                      } @else if (isLista){
                        <div>
                          {{ informacionTiposEntrada?.listaOcioDTO?.precio }}€
                        </div>
                      }
                    </h3>
                    <h4 class="resumen card-subtitle mb-2 text-body-secondary">
                      <div>Subtotal</div>
                      <div>{{ subtotal }}€</div>
                    </h4>
                    <h4 class="resumen card-subtitle mb-2 text-body-secondary">
                      <div>Promociones</div>
                      <div>{{ promociones }}€</div>
                    </h4>
                    <hr>
                    <h1 class="resumen card-subtitle mb-2 text-body-secondary">
                      <div>TOTAL</div>
                      <div>{{ precioFinal }}€</div>
                    </h1>
                  </div>
                </div>

              </div>

            </ion-content>
          </ng-template>
        </ion-modal>


      } @else {
        <p class=" text">Este evento ya ha ocurrido.</p>
      }
    </div>
  </div>
</div>
<app-footerocionocturno></app-footerocionocturno>
</body>
